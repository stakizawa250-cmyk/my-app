<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>住宅改修写真台帳作成ツール</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel (JSX変換用) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    /* 印刷時のスタイル調整 */
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
    /* アプリ用基本スタイル */
    body {
      background-color: #f3f4f6;
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- アイコンコンポーネント (Lucide互換SVG) ---
    const IconBase = ({ children, className, ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
    );
    const Camera = (props) => <IconBase {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>;
    const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>;
    const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
    const ArrowUp = (props) => <IconBase {...props}><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></IconBase>;
    const ArrowDown = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></IconBase>;
    const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
    const FileText = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>;
    const Calendar = (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>;
    const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>;
    const Check = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>;
    const Loader2 = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
    const RefreshCw = (props) => <IconBase {...props}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconBase>;
    const PlusSquare = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></IconBase>;
    const MinusSquare = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="8" y1="12" x2="16" y2="12"/></IconBase>;
    const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
    const FolderOpen = (props) => <IconBase {...props}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></IconBase>;
    const FilePlus = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></IconBase>;

    // --- 定数定義 ---
    const SUGGESTED_LOCATIONS = [
      "浴室", "便所", "玄関", "廊下", "階段", "居室", "洗面所", "台所", "玄関アプローチ", "その他"
    ];

    const SUGGESTED_TYPES = [
      "手すりの取付け", "段差の解消", "滑りの防止及び移動の円滑化等のための床又は通路面の材料の変更", 
      "引き戸等への扉の取替え", "洋式便器等への便器の取替え", "その他"
    ];

    const STORAGE_KEY = 'construction_photo_log_v1';

    // --- アプリケーションコンポーネント ---
    function ConstructionPhotoLogApp() {
      const initialState = {
        clientName: '',
        pairs: [],
        defaultDate: new Date().toISOString().split('T')[0],
        isPdfLoading: false,
        isScriptLoaded: false,
      };

      const [state, setState] = useState(initialState);
      const [viewMode, setViewMode] = useState('edit'); // 'edit' | 'preview'
      const fileInputRef = useRef(null);
      const isLoadedRef = useRef(false);

      // 初期化（スクリプトロード確認＆データ復元）
      useEffect(() => {
        // html2pdfが読み込まれたか確認
        if (window.html2pdf) {
          setState(prev => ({ ...prev, isScriptLoaded: true }));
        } else {
          // CDNのロード待ち（念のため）
          const interval = setInterval(() => {
            if (window.html2pdf) {
              setState(prev => ({ ...prev, isScriptLoaded: true }));
              clearInterval(interval);
            }
          }, 500);
        }

        // localStorageからデータ復元
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
          try {
            const parsed = JSON.parse(savedData);
            if (parsed && Array.isArray(parsed.pairs)) {
              setState(prev => ({
                ...prev,
                clientName: parsed.clientName || '',
                pairs: parsed.pairs,
                defaultDate: parsed.defaultDate || prev.defaultDate,
              }));
            } else {
              addPairInternal();
            }
          } catch (e) {
            console.error("Failed to load saved data", e);
            addPairInternal();
          }
        } else {
          addPairInternal();
        }
        isLoadedRef.current = true;
      }, []);

      // 自動保存
      useEffect(() => {
        if (isLoadedRef.current) {
          const dataToSave = {
            clientName: state.clientName,
            pairs: state.pairs,
            defaultDate: state.defaultDate,
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        }
      }, [state.clientName, state.pairs, state.defaultDate]);

      // --- ロジック関数 ---

      function generateId() {
        return Math.random().toString(36).substr(2, 9);
      }

      function addPairInternal() {
        setState(prev => {
          const newPair = {
            id: generateId(),
            locationName: '',
            constructionType: '',
            beforeDate: prev.defaultDate,
            afterDate: prev.defaultDate,
            beforePhoto: null,
            afterPhoto: null,
            hasDetails: false, 
            beforeDetailPhoto: null,
            afterDetailPhoto: null,
            memo: '',
            isDeleting: false
          };
          return { ...prev, pairs: [...prev.pairs, newPair] };
        });
      }

      function calculatePages(pairs) {
        const pages = [];
        let currentPageItems = [];
        const MAX_ITEMS_PER_PAGE = 2;

        pairs.forEach(pair => {
          if (currentPageItems.length >= MAX_ITEMS_PER_PAGE) {
            pages.push({ items: currentPageItems });
            currentPageItems = [pair];
          } else {
            currentPageItems.push(pair);
          }
        });

        if (currentPageItems.length > 0) {
          pages.push({ items: currentPageItems });
        }

        return pages;
      }

      // --- PDF生成処理 ---
      const handleStartPdfGeneration = async () => {
        if (!state.isScriptLoaded) {
          alert("PDF生成ライブラリの読み込み中です。少々お待ちください。");
          return;
        }
        
        setViewMode('preview');
        setState(prev => ({ ...prev, isPdfLoading: true }));

        await new Promise(resolve => setTimeout(resolve, 1500));

        const element = document.getElementById('print-layout-root');
        if (!element) {
          alert('印刷レイアウトの取得に失敗しました');
          setState(prev => ({ ...prev, isPdfLoading: false }));
          setViewMode('edit');
          return;
        }

        const opt = {
          margin: 0,
          filename: `住宅改修写真台帳_${state.clientName || '未設定'}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { 
            scale: 2, 
            useCORS: true, 
            allowTaint: true,
            logging: false,
            windowWidth: 794, 
            scrollX: 0,
            scrollY: 0,
            x: 0,
            y: 0
          },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
          pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        try {
          await window.html2pdf().from(element).set(opt).save();
        } catch (err) {
          console.error(err);
          alert("PDF生成中にエラーが発生しました。");
        } finally {
          setState(prev => ({ ...prev, isPdfLoading: false }));
          setViewMode('edit');
        }
      };

      // --- データ操作 ---
      const handleResetData = () => {
        if (confirm("入力内容をすべて消去して、新しい帳票を作成しますか？\n（この操作は取り消せません）")) {
          localStorage.removeItem(STORAGE_KEY);
          setState(prev => ({
            ...initialState,
            isScriptLoaded: prev.isScriptLoaded
          }));
          addPairInternal();
        }
      };

      const handleSaveData = () => {
        const dataToSave = {
          clientName: state.clientName,
          pairs: state.pairs,
          defaultDate: state.defaultDate,
          version: "5.0"
        };
        const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `住宅改修データ_${state.clientName || '未設定'}_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const handleLoadClick = () => {
        if (fileInputRef.current) {
          fileInputRef.current.value = ''; 
          fileInputRef.current.click();
        }
      };

      const handleFileChange = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const json = event.target.result;
            const loadedData = JSON.parse(json);

            if (!loadedData.pairs || !Array.isArray(loadedData.pairs)) {
              alert("無効なデータファイルです。");
              return;
            }

            if (confirm("現在の入力内容を破棄して、ファイルを読み込みますか？")) {
              setState(prev => ({
                ...prev,
                clientName: loadedData.clientName || '',
                pairs: loadedData.pairs,
                defaultDate: loadedData.defaultDate || prev.defaultDate,
              }));
            }
          } catch (err) {
            console.error(err);
            alert("ファイルの読み込みに失敗しました。");
          }
        };
        reader.readAsText(file);
      };

      // --- イベントハンドラ ---
      const handleInputChange = (field, value) => {
        setState(prev => ({ ...prev, [field]: value }));
      };

      const handlePairChange = (id, field, value) => {
        setState(prev => ({
          ...prev,
          pairs: prev.pairs.map(p => p.id === id ? { ...p, [field]: value } : p)
        }));
      };

      const addPair = () => addPairInternal();

      const startRemovePair = (id) => handlePairChange(id, 'isDeleting', true);
      const cancelRemovePair = (id) => handlePairChange(id, 'isDeleting', false);
      const confirmRemovePair = (id) => {
        setState(prev => ({ ...prev, pairs: prev.pairs.filter(p => p.id !== id) }));
      };

      const movePair = (index, direction) => {
        const newPairs = [...state.pairs];
        if (direction === 'up' && index > 0) {
          [newPairs[index - 1], newPairs[index]] = [newPairs[index], newPairs[index - 1]];
        } else if (direction === 'down' && index < newPairs.length - 1) {
          [newPairs[index], newPairs[index + 1]] = [newPairs[index + 1], newPairs[index]];
        }
        setState(prev => ({ ...prev, pairs: newPairs }));
      };

      const toggleDetails = (id) => {
        const pair = state.pairs.find(p => p.id === id);
        if (pair) {
          handlePairChange(id, 'hasDetails', !pair.hasDetails);
        }
      };

      // --- 画像処理 ---
      const processImage = (file, dateText) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              const maxDim = 1600;
              let width = img.width;
              let height = img.height;
              
              if (width > height) {
                if (width > maxDim) { height *= maxDim / width; width = maxDim; }
              } else {
                if (height > maxDim) { width *= maxDim / height; height = maxDim; }
              }
              canvas.width = width;
              canvas.height = height;

              if (ctx) {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);
                ctx.drawImage(img, 0, 0, width, height);

                if (dateText) {
                  const fontSize = Math.floor(Math.max(width, height) * 0.035);
                  ctx.font = `bold ${fontSize}px sans-serif`;
                  ctx.textAlign = 'right';
                  ctx.textBaseline = 'bottom';
                  const x = width - 40;
                  const y = height - 40;
                  const text = dateText.replace(/-/g, '/');
                  ctx.strokeStyle = 'rgba(0,0,0,0.8)';
                  ctx.lineWidth = fontSize / 6;
                  ctx.lineJoin = 'round';
                  ctx.strokeText(text, x, y);
                  ctx.fillStyle = '#ff7700';
                  ctx.fillText(text, x, y);
                }
              }
              resolve({
                id: generateId(),
                dataUrl: canvas.toDataURL('image/jpeg', 0.85),
                timestamp: dateText,
                isDateStamped: !!dateText
              });
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };

      const handlePhotoUpload = async (pairId, photoType, e) => {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          const pair = state.pairs.find(p => p.id === pairId);
          if (!pair) return;

          const targetDate = (photoType.startsWith('before')) ? pair.beforeDate : pair.afterDate;
          const useDate = targetDate || state.defaultDate;
          
          const processedPhoto = await processImage(file, useDate);
          
          let targetProp = 'beforePhoto';
          if (photoType === 'after') targetProp = 'afterPhoto';
          if (photoType === 'beforeDetail') targetProp = 'beforeDetailPhoto';
          if (photoType === 'afterDetail') targetProp = 'afterDetailPhoto';

          handlePairChange(pairId, targetProp, processedPhoto);
        }
      };

      const removePhoto = (pairId, photoType) => {
        let targetProp = 'beforePhoto';
        if (photoType === 'after') targetProp = 'afterPhoto';
        if (photoType === 'beforeDetail') targetProp = 'beforeDetailPhoto';
        if (photoType === 'afterDetail') targetProp = 'afterDetailPhoto';

        handlePairChange(pairId, targetProp, null);
      };

      // --- サブコンポーネント: PhotoUploadCard ---
      const PhotoUploadCard = ({ photo, label, date, onUpload, onRemove, onDateChange, isDetail = false }) => (
        <div className="flex flex-col gap-2 h-full">
          <div className="flex justify-between items-end border-b border-gray-200 pb-1 mb-1">
            <div className={`font-bold text-sm px-3 py-1 rounded-t ${isDetail ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-700'}`}>
              {label}
            </div>
            {onDateChange && date !== undefined && (
              <label className="flex items-center gap-1 text-xs text-gray-600 bg-white border border-gray-300 px-2 py-0.5 rounded cursor-pointer hover:bg-gray-50">
                 <Calendar className="w-3 h-3" />
                 撮影日:
                 <input 
                   type="date" 
                   value={date}
                   onChange={(e) => onDateChange(e.target.value)}
                   className="bg-transparent border-none text-gray-800 p-0 focus:ring-0 text-xs w-24 ml-1 cursor-pointer"
                 />
              </label>
            )}
          </div>

          <div className={`relative aspect-[4/3] border-2 border-dashed rounded-lg flex items-center justify-center transition overflow-hidden group ${isDetail ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-300'}`}>
            {photo ? (
              <>
                <img src={photo.dataUrl} alt={label} className="w-full h-full object-contain" />
                <div className="absolute top-0 right-0 p-2 flex gap-2 opacity-0 group-hover:opacity-100 transition duration-200">
                  <label className="bg-blue-600 text-white p-2 rounded-full shadow-lg cursor-pointer hover:bg-blue-700" title="入れ替え">
                    <RefreshCw className="w-4 h-4" />
                    <input type="file" accept="image/*" className="hidden" onChange={onUpload} />
                  </label>
                  <button onClick={onRemove} className="bg-red-600 text-white p-2 rounded-full shadow-lg hover:bg-red-700" title="削除">
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
                <div className="absolute bottom-2 left-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded backdrop-blur-sm pointer-events-none">
                  {date ? `設定日: ${date}` : '日付なし'}
                </div>
              </>
            ) : (
              <label className="cursor-pointer w-full h-full flex flex-col items-center justify-center text-gray-400 hover:text-emerald-600 transition">
                <Upload className={`w-8 h-8 mb-2 opacity-50 ${isDetail ? 'text-orange-400' : ''}`} />
                <span className="text-xs font-bold text-center px-2">{label}を選択</span>
                <input type="file" accept="image/*" className="hidden" onChange={onUpload} />
              </label>
            )}
          </div>
        </div>
      );

      // --- 印刷用レイアウト ---
      const PrintLayout = ({ pages }) => {
        return (
          <div 
            id="print-layout-root"
            style={{ 
              width: '210mm', 
              minHeight: '297mm', 
              marginBottom: '50px',
              backgroundColor: 'white',
              boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'
            }}
          >
            <style>{`
              .print-page {
                width: 210mm;
                height: 296mm;
                padding: 8mm 10mm;
                box-sizing: border-box;
                position: relative;
                overflow: hidden;
                page-break-after: always;
                font-family: "Helvetica Neue", Arial, sans-serif;
                display: flex;
                flex-direction: column;
                background-color: white;
              }
              .print-table { width: 100%; border-collapse: collapse; border: 1px solid black; font-size: 10pt; margin-bottom: 5px; }
              .print-table th { background: #f0f0f0; border: 1px solid black; padding: 2px; text-align: center; font-weight: bold; }
              .print-table td { border: 1px solid black; padding: 2px; }
              .photo-box-large { height: 260px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background: #fff; }
              .photo-box-small { height: 185px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background: #fff; }
              .photo-img { max-width: 100%; max-height: 100%; object-fit: contain; }
              .memo-area { height: 50px; overflow: hidden; border: 1px dotted #999; padding: 2px; margin-top: 2px; font-size: 10px; }
              .memo-area-small { height: 30px; overflow: hidden; border: 1px dotted #999; padding: 2px; margin-top: 2px; font-size: 9px; }
              .grid-compact { gap: 4px; }
            `}</style>

            {pages.map((page, pageIndex) => (
              <div key={pageIndex} className="print-page">
                <div className="text-center mb-1">
                  <h1 className="text-lg font-bold border-b-2 border-black inline-block pb-1 px-4">写真貼付用紙 (介護保険住宅改修用)</h1>
                </div>

                <table className="print-table">
                  <tbody>
                    <tr>
                      <th style={{ width: '20%' }}>被保険者氏名</th>
                      <td style={{ width: '80%' }}>{state.clientName}</td>
                    </tr>
                  </tbody>
                </table>

                <div className="flex-1 flex flex-col gap-2">
                  {page.items.map((pair, i) => {
                    const pairIndex = state.pairs.findIndex(p => p.id === pair.id);
                    
                    return (
                      <div key={pair.id} className="border-2 border-black p-1" style={{ flex: '1 1 auto' }}>
                        <div className="flex border-b border-black mb-1 pb-1 bg-gray-100 px-1 items-center">
                          <span className="font-bold border border-black bg-white w-5 h-5 flex items-center justify-center rounded-full mr-2 text-xs">
                            {pairIndex + 1}
                          </span>
                          <div className="flex-1 grid grid-cols-2 gap-2 text-xs">
                            <div><span className="font-bold mr-1">改修箇所:</span> {pair.locationName}</div>
                            <div><span className="font-bold mr-1">工事種別:</span> {pair.constructionType}</div>
                          </div>
                        </div>

                        {pair.hasDetails ? (
                          <div className="grid grid-cols-2 grid-compact">
                            <div className="flex flex-col gap-0.5">
                              <div className="text-center font-bold bg-gray-50 text-[9px] py-0.5">改修前 (全体)</div>
                              <div className="photo-box-small">
                                {pair.beforePhoto ? <img src={pair.beforePhoto.dataUrl} className="photo-img" /> : <span className="text-gray-300 text-xs">写真なし</span>}
                              </div>
                            </div>
                            <div className="flex flex-col gap-0.5">
                              <div className="text-center font-bold bg-orange-50 text-[9px] py-0.5">改修前 (詳細/メジャー等)</div>
                              <div className="photo-box-small">
                                {pair.beforeDetailPhoto ? <img src={pair.beforeDetailPhoto.dataUrl} className="photo-img" /> : <span className="text-gray-300 text-xs">写真なし</span>}
                              </div>
                            </div>
                            
                            <div className="flex flex-col gap-0.5">
                              <div className="text-center font-bold bg-gray-50 text-[9px] py-0.5">改修後 (全体)</div>
                              <div className="photo-box-small">
                                {pair.afterPhoto ? <img src={pair.afterPhoto.dataUrl} className="photo-img" /> : <span className="text-gray-300 text-xs">写真なし</span>}
                              </div>
                            </div>
                            <div className="flex flex-col gap-0.5">
                              <div className="text-center font-bold bg-orange-50 text-[9px] py-0.5">改修後 (詳細/メジャー等)</div>
                              <div className="photo-box-small">
                                {pair.afterDetailPhoto ? <img src={pair.afterDetailPhoto.dataUrl} className="photo-img" /> : <span className="text-gray-300 text-xs">写真なし</span>}
                              </div>
                            </div>

                            <div className="col-span-2 memo-area-small">
                               <span className="text-[9px] bg-gray-200 px-1 rounded mr-1 inline-block">メモ</span>
                               <span className="leading-tight whitespace-pre-wrap">{pair.memo}</span>
                            </div>
                          </div>
                        ) : (
                          <div className="grid grid-cols-2 gap-2">
                            <div>
                              <div className="text-center font-bold border-b border-gray-400 mb-0.5 text-xs">改修前</div>
                              <div className="photo-box-large">
                                 {pair.beforePhoto ? <img src={pair.beforePhoto.dataUrl} className="photo-img" /> : <div className="text-gray-300 text-xs">（写真なし）</div>}
                              </div>
                              <div className="memo-area">
                                 <span className="text-[9px] bg-gray-200 px-1 rounded mr-1 inline-block">予定図/メモ</span>
                                 <span className="text-[10px] leading-tight whitespace-pre-wrap">{pair.memo}</span>
                              </div>
                            </div>
                            <div>
                              <div className="text-center font-bold border-b border-gray-400 mb-0.5 text-xs">改修後</div>
                              <div className="photo-box-large">
                                {pair.afterPhoto ? <img src={pair.afterPhoto.dataUrl} className="photo-img" /> : <div className="text-gray-300 text-xs">（写真なし）</div>}
                              </div>
                              <div className="h-[52px] mt-0.5 flex items-end justify-center">
                                <span className="text-[9px] text-gray-500">※同じアングルで撮影</span>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>

                <div className="text-center text-[10px] text-gray-400 mt-auto pt-1">
                  - {pageIndex + 1} / {pages.length} -
                </div>
              </div>
            ))}
          </div>
        );
      };

      // --- メインレンダリング分岐 ---
      const printPages = calculatePages(state.pairs);

      // PDF生成モード（プレビュー表示）
      if (viewMode === 'preview') {
        return (
          <div className="fixed inset-0 z-[9999] bg-gray-200 overflow-auto flex justify-center items-start pt-10">
            {state.isPdfLoading && (
              <div className="fixed inset-0 bg-black/80 z-[10000] flex flex-col items-center justify-center text-white pointer-events-none">
                <Loader2 className="w-12 h-12 animate-spin mb-4" />
                <h2 className="text-xl font-bold">PDFを生成しています...</h2>
                <p className="text-sm opacity-80 mt-2">画面が切り替わりますが、そのままでお待ちください</p>
              </div>
            )}
            
            {/* 印刷レイアウト本体 */}
            <PrintLayout pages={printPages} />
          </div>
        );
      }

      // 通常編集モード
      return (
        <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-20 relative">
          <header className="bg-emerald-700 text-white p-4 shadow-md sticky top-0 z-50">
            <div className="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
              <div className="flex items-center gap-2">
                <Camera className="w-6 h-6" />
                <h1 className="text-xl font-bold">住宅改修写真台帳作成ツール</h1>
              </div>
              <div className="flex gap-2 items-center">
                <button 
                  onClick={handleResetData}
                  className="flex items-center gap-1.5 bg-red-600 text-white px-3 py-1.5 rounded hover:bg-red-700 transition text-sm mr-2"
                  title="データをリセット"
                >
                  <FilePlus className="w-4 h-4" />
                  新規
                </button>

                <input type="file" accept=".json" ref={fileInputRef} className="hidden" onChange={handleFileChange} />
                <button onClick={handleLoadClick} className="flex items-center gap-1.5 bg-emerald-800 text-white px-3 py-1.5 rounded hover:bg-emerald-900 transition text-sm border border-emerald-600" title="読込">
                  <FolderOpen className="w-4 h-4" />
                  読込
                </button>

                <button onClick={handleSaveData} className="flex items-center gap-1.5 bg-emerald-800 text-white px-3 py-1.5 rounded hover:bg-emerald-900 transition text-sm border border-emerald-600 mr-2" title="保存">
                  <Save className="w-4 h-4" />
                  保存
                </button>

                <button onClick={handleStartPdfGeneration} disabled={!state.isScriptLoaded || state.isPdfLoading} className="flex items-center gap-2 bg-white text-emerald-800 px-4 py-1.5 rounded-full font-bold hover:bg-emerald-50 transition shadow disabled:opacity-70 disabled:cursor-wait text-sm">
                  <Download className="w-4 h-4" />
                  PDF保存
                </button>
              </div>
            </div>
          </header>

          <main className="max-w-5xl mx-auto p-4">
            <datalist id="suggested-locations">{SUGGESTED_LOCATIONS.map(v => <option key={v} value={v} />)}</datalist>
            <datalist id="suggested-types">{SUGGESTED_TYPES.map(v => <option key={v} value={v} />)}</datalist>

            <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4 mb-6 flex items-start gap-3">
              <AlertCircle className="w-5 h-5 text-emerald-600 mt-0.5 flex-shrink-0" />
              <div className="text-sm text-emerald-800">
                <p className="font-bold mb-1">使い方:</p>
                <ul className="list-disc pl-4 space-y-1">
                  <li>入力内容は自動的に保存されます。</li>
                  <li>「保存」ボタンでバックアップファイル(JSON)をダウンロードできます。</li>
                  <li>「新規」ボタンでデータをリセットします。</li>
                </ul>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
              <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-gray-700 border-b pb-2">
                <FileText className="w-5 h-5" />
                基本情報
              </h2>
              <div className="grid grid-cols-1 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">被保険者氏名</label>
                  <input type="text" value={state.clientName} onChange={(e) => handleInputChange('clientName', e.target.value)} placeholder="例: 介護 太郎" className="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-emerald-500 focus:outline-none" />
                </div>
              </div>
              <div className="mt-4 pt-4 border-t border-gray-100 flex items-center gap-2 text-sm text-gray-600">
                 <Calendar className="w-4 h-4" />
                 <span>デフォルト日付:</span>
                 <input type="date" value={state.defaultDate} onChange={(e) => handleInputChange('defaultDate', e.target.value)} className="bg-gray-50 border border-gray-300 rounded px-2 py-1 ml-2" />
              </div>
            </div>

            <div className="space-y-8">
              {state.pairs.map((pair, index) => (
                <div key={pair.id} className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden relative">
                  <div className="bg-gray-50 p-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div className="flex items-center gap-3 w-full md:w-auto">
                      <span className="bg-emerald-600 text-white rounded-full w-8 h-8 flex-shrink-0 flex items-center justify-center text-sm font-bold">{index + 1}</span>
                      <div className="flex flex-col sm:flex-row gap-2 w-full">
                        <input type="text" list="suggested-locations" placeholder="改修箇所" value={pair.locationName} onChange={(e) => handlePairChange(pair.id, 'locationName', e.target.value)} className="border border-gray-300 rounded px-2 py-1.5 text-sm w-full sm:w-40 focus:ring-1 focus:ring-emerald-500" />
                        <input type="text" list="suggested-types" placeholder="工事種別" value={pair.constructionType} onChange={(e) => handlePairChange(pair.id, 'constructionType', e.target.value)} className="border border-gray-300 rounded px-2 py-1.5 text-sm w-full sm:w-60 focus:ring-1 focus:ring-emerald-500" />
                      </div>
                    </div>
                    <div className="flex items-center gap-1">
                       <button onClick={() => toggleDetails(pair.id)} className={`flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold transition mr-2 ${pair.hasDetails ? 'bg-orange-100 text-orange-700 border border-orange-200' : 'bg-gray-100 text-gray-500 hover:bg-gray-200 border border-transparent'}`}>
                        {pair.hasDetails ? <MinusSquare className="w-4 h-4" /> : <PlusSquare className="w-4 h-4" />}
                        {pair.hasDetails ? '詳細写真あり' : '詳細写真を追加'}
                      </button>
                      <button onClick={() => movePair(index, 'up')} disabled={index === 0} className="p-2 text-gray-400 hover:text-emerald-600 disabled:opacity-20 hover:bg-gray-100 rounded"><ArrowUp className="w-5 h-5" /></button>
                      <button onClick={() => movePair(index, 'down')} disabled={index === state.pairs.length - 1} className="p-2 text-gray-400 hover:text-emerald-600 disabled:opacity-20 hover:bg-gray-100 rounded"><ArrowDown className="w-5 h-5" /></button>
                      {pair.isDeleting ? (
                        <div className="flex items-center gap-2 bg-red-50 px-2 py-1 rounded border border-red-200 ml-2">
                          <span className="text-xs text-red-600 font-bold">削除?</span>
                          <button onClick={() => confirmRemovePair(pair.id)} className="bg-red-600 text-white text-xs px-2 py-1 rounded hover:bg-red-700">はい</button>
                          <button onClick={() => cancelRemovePair(pair.id)} className="text-gray-500 text-xs px-2 py-1 hover:text-gray-700 hover:bg-gray-200 rounded">Cancel</button>
                        </div>
                      ) : (
                        <button onClick={() => startRemovePair(pair.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition ml-2"><Trash2 className="w-5 h-5" /></button>
                      )}
                    </div>
                  </div>

                  <div className={`p-4 grid gap-6 transition-all ${pair.hasDetails ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-2' : 'grid-cols-1 md:grid-cols-2'}`}>
                    <div className={`flex flex-col gap-4 ${pair.hasDetails ? 'p-3 bg-gray-50/50 rounded-lg border border-gray-100' : ''}`}>
                      <PhotoUploadCard label="改修前 (Before)" photo={pair.beforePhoto} date={pair.beforeDate} onDateChange={(d) => handlePairChange(pair.id, 'beforeDate', d)} onUpload={(e) => handlePhotoUpload(pair.id, 'before', e)} onRemove={() => removePhoto(pair.id, 'before')} />
                      {pair.hasDetails && (
                        <div className="mt-2 pt-2 border-t border-dashed border-gray-300">
                           <PhotoUploadCard label="改修前 詳細 (メジャー等)" isDetail photo={pair.beforeDetailPhoto} date={pair.beforeDate} onUpload={(e) => handlePhotoUpload(pair.id, 'beforeDetail', e)} onRemove={() => removePhoto(pair.id, 'beforeDetail')} />
                        </div>
                      )}
                       <textarea placeholder="改修前のメモ" className="text-sm border border-gray-300 rounded p-2 w-full h-20 resize-none focus:ring-1 focus:ring-emerald-500 focus:outline-none mt-auto" value={pair.memo} onChange={(e) => handlePairChange(pair.id, 'memo', e.target.value)} />
                    </div>

                    <div className={`flex flex-col gap-4 ${pair.hasDetails ? 'p-3 bg-gray-50/50 rounded-lg border border-gray-100' : ''}`}>
                       <PhotoUploadCard label="改修後 (After)" photo={pair.afterPhoto} date={pair.afterDate} onDateChange={(d) => handlePairChange(pair.id, 'afterDate', d)} onUpload={(e) => handlePhotoUpload(pair.id, 'after', e)} onRemove={() => removePhoto(pair.id, 'after')} />
                      {pair.hasDetails && (
                        <div className="mt-2 pt-2 border-t border-dashed border-gray-300">
                           <PhotoUploadCard label="改修後 詳細 (メジャー等)" isDetail photo={pair.afterDetailPhoto} date={pair.afterDate} onUpload={(e) => handlePhotoUpload(pair.id, 'afterDetail', e)} onRemove={() => removePhoto(pair.id, 'afterDetail')} />
                        </div>
                      )}
                      <div className="text-xs text-emerald-700 p-3 bg-emerald-50 rounded border border-emerald-100 mt-auto">
                        <span className="font-bold flex items-center gap-1 mb-1"><Check className="w-3 h-3" /> 撮影ポイント:</span> 
                        Beforeと同じアングルで撮影。詳細写真にはメジャーの目盛りが読めるように接写してください。
                      </div>
                    </div>
                  </div>
                </div>
              ))}

              <button onClick={addPair} className="w-full py-6 border-2 border-dashed border-emerald-300 text-emerald-600 rounded-lg hover:bg-emerald-50 font-bold flex flex-col items-center justify-center gap-2 transition group">
                <div className="bg-emerald-600 text-white rounded-full p-2 group-hover:scale-110 transition"><ArrowUp className="w-6 h-6 rotate-45" /></div>
                <span>新しい改修箇所を追加する</span>
              </button>
            </div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ConstructionPhotoLogApp />);
  </script>
</body>

</html>
